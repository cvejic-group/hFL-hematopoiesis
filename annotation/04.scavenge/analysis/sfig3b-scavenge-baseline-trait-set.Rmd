---
title: "SCAVENGE Blood Trait Set"
author: "Mervin M Fansler"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document: 
    code_folding: show
    df_print: paged
    theme: cosmo
    toc: true
    toc_float: true
---

# Purpose

Here we explore the SCAVENGE results for the default blood trait set used in the original paper.

# Initialization

## Libraries
```{r libs, message=FALSE, warning=FALSE}
library(SummarizedExperiment)
library(HDF5Array)
library(tidyverse)
library(magrittr)
library(pheatmap)
```

## Parameters
```{r set_params}
set.seed(20241202)

PATH_INPUT="/work/DevM_analysis/06.phenotypes/01.archr_export/se/"
PREFIX_INPUT="se_peak10k_cell10k_48FL_"
CSV_TRAIT_SET="/work/DevM_analysis/06.phenotypes/02.scavenge_pipeline/results/trs/df_trs_scavenge_yu_2022_knn30_bg200_rng20241106.csv.gz"

df_coldata <- tibble(
  celltype=c("35-MDP", "49-MEMP", "49:2-MastP", "ASDC", "Cycling_LP", "Early-Ery", 
             "Endothelia", "GP", "Granulocyte", "HSC", "Hepatocyte", "ILCP", 
             "IM-B", "Kupffer", "LMPP", "LP", "Large-PreB", "Late-Ery", "MEMP", 
             "MEMP-Ery", "MEMP-MK", "MEMP-Mast-Ery", "MEP", "MK", "Mast", 
             "MastP", "Monocyte", "NK", "PreProB", "ProB-1", "ProB-2", "Small-PreB", 
             "T", "cDC1", "cDC2", "pDC")
) %>% column_to_rownames("celltype")

df_rowdata <- tibble(
  trait=c("lymph", 
          "wbc", "neut", "mono", "eo", "baso",
          "plt", "mpv", "pct", "pdw",
          "hct", "hlr", "ret", "irf", "mrv", "mscv", "rdw", "mchc", "rbc", "mch", "mcv", "hgb"),
  "Trait Category"=c("Lymphoid white cell", 
                     rep("Myeloid/compound white cell", 5),
                     rep("Platelet", 4),
                     rep("Red cell", 12))
) %>% column_to_rownames("trait")



SCAV_COLS=colorRampPalette(c("#F9F6F4", "#F1DEDA", "#C684AA", "#6B4E80", "#4D4665"))(100)
SCAV_COLS2=viridisLite::magma(100)
ANNOT_COLS=list("Trait Category"=c("Lymphoid white cell"="#799C6A", 
                     "Myeloid/compound white cell"="#5E88AB",
                     "Platelet"="#D5A45D",
                     "Red cell"="#A65660"))

Z_COLS=colorRampPalette(c("#5E88AB", "#F9F6F4", "#A65660"))(21)
#Z_COLS2=colorRampPalette(BuenColors::jdb_palette("aqua_brick"))(21)
Z_COLS2=colorRampPalette(c("#1a8cb4", "#F9F6F4", "#97412d"))(21)
Z_BREAKS=seq(-4,4, length=22)

theme_set(theme_bw())
```

# Data
## Loading
```{r load_data, message=FALSE}
se_peak_cell <- loadHDF5SummarizedExperiment(PATH_INPUT, PREFIX_INPUT)

df_trait <- read_csv(CSV_TRAIT_SET, show_col_types=FALSE) %>%
  filter(!trait_id %in% c("all", "covid19"))
```

## Merge Data
```{r merge_data}
df_umap <- metadata(se_peak_cell)$reducedDims$UMAP[unique(df_trait$cell_id),] %>% 
  `colnames<-`(c("UMAP1", "UMAP2")) %>%
  as_tibble(rownames="cell_id")
df_lsi <- metadata(se_peak_cell)$reducedDims$LSI[unique(df_trait$cell_id),] %>%
  as_tibble(rownames="cell_id")

df_trait <- colData(se_peak_cell[,unique(df_trait$cell_id)]) %>%
  as_tibble(rownames="cell_id") %>%
  left_join(x=df_trait, by="cell_id") %>%
  left_join(df_umap, by="cell_id") %>% 
  left_join(df_lsi, by="cell_id") %>%
  mutate(is_omitted=is.na(trs_raw)) %>%
  filter(!celltype %in% c("Endothelia", "Hepatocyte"))
```


# chromVAR
## Z-Scores
```{r summarize_zscores}
df_z <- df_trait %>%
  group_by(celltype, trait_id) %>%
  summarise(mean_z_score=mean(z_score, na.rm=TRUE),
            median_z_score=median(z_score, na.rm=TRUE),
            .groups='drop')

mat_mean_z <- df_z %>%
  dplyr::select(celltype, trait_id, mean_z_score) %>%
  pivot_wider(names_from="celltype", values_from="mean_z_score") %>%
  column_to_rownames("trait_id") %>%
  as.matrix

mat_median_z <- df_z %>%
  dplyr::select(celltype, trait_id, median_z_score) %>%
  pivot_wider(names_from="celltype", values_from="median_z_score") %>%
  column_to_rownames("trait_id") %>%
  as.matrix
```

### Mean
```{r heatmap_mean_z, fig.width=11, fig.height=6}
pheatmap(mat_mean_z, scale="none", annotation_row=df_rowdata, cutree_rows=5, color=Z_COLS2, breaks=Z_BREAKS,
         annotation_colors=ANNOT_COLS, border_color="white")
pheatmap(mat_mean_z, scale="row", annotation_row=df_rowdata, cutree_rows=4, color=Z_COLS2, breaks=Z_BREAKS,
         annotation_colors=ANNOT_COLS, border_color="white")
```

### Median
```{r heatmap_median_z, fig.width=12, fig.height=6}
pheatmap(mat_median_z, scale="none", annotation_row=df_rowdata, cutree_rows=5, color=Z_COLS2, breaks=Z_BREAKS,
         annotation_colors=ANNOT_COLS, border_color="white")
pheatmap(mat_median_z, scale="row", annotation_row=df_rowdata, cutree_rows=4, color=Z_COLS2, breaks=Z_BREAKS,
         annotation_colors=ANNOT_COLS, border_color="white")
```

# SCAVENGE TRS
## Raw
```{r summarize_trs_raw}
df_trs_raw <- df_trait %>%
  group_by(celltype, trait_id) %>%
  summarise(mean_trs_raw=mean(trs_raw, na.rm=TRUE),
            median_trs_raw=median(trs_raw, na.rm=TRUE),
            .groups='drop')

mat_mean_trs_raw <- df_trs_raw %>%
  dplyr::select(celltype, trait_id, mean_trs_raw) %>%
  pivot_wider(names_from="celltype", values_from="mean_trs_raw") %>%
  column_to_rownames("trait_id") %>%
  as.matrix

mat_median_trs_raw <- df_trs_raw %>%
  dplyr::select(celltype, trait_id, median_trs_raw) %>%
  pivot_wider(names_from="celltype", values_from="median_trs_raw") %>%
  column_to_rownames("trait_id") %>%
  as.matrix
```

### Mean
```{r heatmap_mean_trs_raw, fig.width=12, fig.height=6}
pheatmap(mat_mean_trs_raw, scale="none", annotation_row=df_rowdata, cutree_rows=4, color=SCAV_COLS,
         annotation_colors=ANNOT_COLS, border_color="white")
pheatmap(mat_mean_trs_raw, scale="row", annotation_row=df_rowdata, cutree_rows=4, color=Z_COLS2, breaks=Z_BREAKS,
         annotation_colors=ANNOT_COLS, border_color="white")
```

### Median
```{r heatmap_median_trs_raw, fig.width=12, fig.height=6}
pheatmap(mat_median_trs_raw, scale="none", annotation_row=df_rowdata, cutree_rows=4, color=SCAV_COLS,
         annotation_colors=ANNOT_COLS, border_color="white")
pheatmap(mat_median_trs_raw, scale="row", annotation_row=df_rowdata, cutree_rows=4, color=Z_COLS2, breaks=Z_BREAKS,
         annotation_colors=ANNOT_COLS, border_color="white")
```


## Scaled
```{r summarize_trs_scaled}
df_trs_scaled <- df_trait %>%
  group_by(celltype, trait_id) %>%
  summarise(mean_trs_scaled=mean(trs_scaled, na.rm=TRUE),
            median_trs_scaled=median(trs_scaled, na.rm=TRUE),
            .groups='drop')

mat_mean_trs_scaled <- df_trs_scaled %>%
  dplyr::select(celltype, trait_id, mean_trs_scaled) %>%
  pivot_wider(names_from="celltype", values_from="mean_trs_scaled") %>%
  column_to_rownames("trait_id") %>%
  as.matrix

mat_median_trs_scaled <- df_trs_scaled %>%
  dplyr::select(celltype, trait_id, median_trs_scaled) %>%
  pivot_wider(names_from="celltype", values_from="median_trs_scaled") %>%
  column_to_rownames("trait_id") %>%
  as.matrix
```

### Mean
```{r heatmap_mean_trs_scaled, fig.width=12, fig.height=6}
pheatmap(mat_mean_trs_scaled, scale="none", annotation_row=df_rowdata, cutree_rows=4, color=SCAV_COLS,
         annotation_colors=ANNOT_COLS, border_color="white")
pheatmap(mat_mean_trs_scaled, scale="row", annotation_row=df_rowdata, cutree_rows=4, color=Z_COLS2, breaks=Z_BREAKS,
         annotation_colors=ANNOT_COLS, border_color="white")
```

### Median
```{r heatmap_median_trs_scaled, fig.width=12, fig.height=6}
pheatmap(mat_median_trs_scaled, scale="none", annotation_row=df_rowdata, cutree_rows=4, color=SCAV_COLS,
         annotation_colors=ANNOT_COLS, border_color="white")

pheatmap(mat_median_trs_scaled, scale="none", annotation_row=df_rowdata, cutree_rows=4, color=SCAV_COLS, main="Median TRS",
         annotation_colors=ANNOT_COLS, border_color="white", filename="img/blood_traits_yu22_median_trs.pdf", width=12, height=6)

pheatmap(mat_median_trs_scaled, scale="row", annotation_row=df_rowdata, cutree_rows=4, color=Z_COLS2, breaks=Z_BREAKS,
         annotation_colors=ANNOT_COLS, border_color="white")
```


```{r heatmap_median_trs_scaled_order, fig.width=10, fig.height=6}
pheatmap(mat_median_trs_scaled[rownames(df_rowdata),], annotation_row=df_rowdata,
         cluster_rows=FALSE, gaps_row=c(1,6,10),
         color=SCAV_COLS, main="Median TRS",
         annotation_colors=ANNOT_COLS, border_color="white")
pheatmap(mat_median_trs_scaled[rownames(df_rowdata),], annotation_row=df_rowdata,
         cluster_rows=FALSE, gaps_row=c(1,6,10),
         color=SCAV_COLS, main="Median TRS",
         annotation_colors=ANNOT_COLS, border_color="white", 
         filename="img/blood_traits_yu22_median_trs_order.pdf", width=10, height=6)
```


# Significantly Enriched Cells
```{r summarize_frac_enriched}
df_enriched <- df_trait %>%
  group_by(celltype, trait_id) %>%
  summarise(frac_enriched=mean(is_enriched, na.rm=TRUE),
            n_enriched=sum(is_enriched, na.rm=TRUE),
            .groups='drop')

mat_n_enriched <- df_enriched %>%
  dplyr::select(celltype, trait_id, n_enriched) %>%
  pivot_wider(names_from="celltype", values_from="n_enriched") %>%
  column_to_rownames("trait_id") %>%
  as.matrix

mat_frac_enriched <- df_enriched %>%
  dplyr::select(celltype, trait_id, frac_enriched) %>%
  pivot_wider(names_from="celltype", values_from="frac_enriched") %>%
  column_to_rownames("trait_id") %>%
  as.matrix
```

### Count
#### Raw
```{r heatmap_n_enriched_raw, fig.width=12, fig.height=6}
pheatmap(mat_n_enriched, annotation_row=df_rowdata, cutree_rows=4, color=SCAV_COLS,
         annotation_colors=ANNOT_COLS, border_color="white")
```

#### Scaled
```{r heatmap_n_enriched_scale, fig.width=12, fig.height=6}
pheatmap(mat_n_enriched, scale="column", annotation_row=df_rowdata, cutree_rows=4, color=Z_COLS2, breaks=Z_BREAKS,
         annotation_colors=ANNOT_COLS, border_color="white")
```

### Fraction
#### Raw
```{r heatmap_frac_enriched_raw, fig.width=12, fig.height=6}
pheatmap(mat_frac_enriched, annotation_row=df_rowdata, cutree_rows=4, color=SCAV_COLS,
         annotation_colors=ANNOT_COLS, border_color="white")

pheatmap(mat_frac_enriched, annotation_row=df_rowdata, cutree_rows=4, color=SCAV_COLS, main="Fraction of Enriched Cells",
         annotation_colors=ANNOT_COLS, border_color="white", filename="img/blood_traits_yu22_fraction_enriched.pdf", 
         width=12, height=6)
```


```{r heatmap_frac_enriched_raw_order, fig.width=10, fig.height=6}
pheatmap(mat_frac_enriched[rownames(df_rowdata),], annotation_row=df_rowdata,
         cluster_rows=FALSE, gaps_row=c(1,6,10),
         color=SCAV_COLS, main="Fraction of Enriched Cells",
         annotation_colors=ANNOT_COLS, border_color="white")

pheatmap(mat_frac_enriched[rownames(df_rowdata),], annotation_row=df_rowdata,
         cluster_rows=FALSE, gaps_row=c(1,6,10),
         color=SCAV_COLS, main="Fraction of Enriched Cells",
         annotation_colors=ANNOT_COLS, border_color="white", 
         filename="img/blood_traits_yu22_fraction_enriched_order.pdf", width=10, height=6)
```

#### Scaled
```{r heatmap_frac_enriched_scaled_row, fig.width=12, fig.height=6}
pheatmap(mat_frac_enriched, scale="row", annotation_row=df_rowdata, cutree_rows=4, color=Z_COLS2, breaks=Z_BREAKS,
         annotation_colors=ANNOT_COLS, border_color="white")
```

```{r heatmap_frac_enriched_scaled_column, fig.width=12, fig.height=6}
pheatmap(mat_frac_enriched, scale="column", annotation_row=df_rowdata, cutree_rows=4, color=Z_COLS2, breaks=Z_BREAKS,
         annotation_colors=ANNOT_COLS, border_color="white")
```

---

# Runtime Details
## Session Info
<details>
```{r sesh_info, echo=FALSE}
sessionInfo()
```
</details>

## Conda Environment
<details>
```{bash conda_info, comment="", echo=FALSE}
if ! command -v conda &> /dev/null
then
  echo "Conda not detected."
elif [ -z "${CONDA_PREFIX}" ]
then
  echo "No active Conda environment."
else
  echo "## Conda Environment YAML"
  PREFIX=$(dirname $(dirname $(which R)))
  conda env export -p $PREFIX
fi
```
</details>
