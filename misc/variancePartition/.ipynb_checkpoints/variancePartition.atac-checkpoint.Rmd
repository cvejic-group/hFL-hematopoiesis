---
title: "variancePartition.atac"
---

- Run `code/variancePartition.atac.R` first

```{r knitr, include = FALSE}
DOCNAME <- "variancePartition.atac"
dir.create(here::here("output", DOCNAME), showWarnings = FALSE)

NOW <- Sys.time()
# Time chunks during knitting
knitr::knit_hooks$set(timeit = function(before) {
  if (before) {
    print(paste("Start:", Sys.time()))
    NOW <<- Sys.time()
  } else {
    print(paste("Stop:", Sys.time()))
    print(Sys.time() - NOW)
  }
})

knitr::opts_chunk$set(
  autodep        = TRUE,
  cache          = FALSE,
  cache.lazy     = FALSE,
  cache.comments = FALSE,
  echo           = TRUE,
  error          = FALSE,
  fig.align      = "center",
  fig.width      = 10,
  fig.height     = 8,
  message        = FALSE,
  warning        = FALSE,
  timeit         = TRUE
)
```

```{r}
library(tidyverse)

# plot
library(scales)
library(scattermore)
library(ggrastr)
library(ggpubr)

# patch
library(patchwork)
library(cowplot)
mytheme <- theme_cowplot(
  font_size = 10,
  rel_small = 8 / 10,
  rel_tiny = 8 / 10,
  rel_large = 10 / 10
)

# color
library(ggsci)

# srat
library(Seurat)

# model
library(variancePartition)
```

```{r source, cache = FALSE}
#source(here::here("utils/preprocess.R"))
#source(here::here("utils/markers.R"))
#source(here::here("utils/color.R"))
source(here::here("utils/plot.R"))
theme_set(publ_theme)
```

## Pseudo-bulk

```{r}
varPart <- readRDS(here::here("output", DOCNAME, "PBvarPart.rds"))
vp <- readRDS(here::here("output", DOCNAME, "PBvp.rds"))
```

show some peaks

```{r fig.width=6, fig.height=8}
# Bar plot of variance fractions for the first 10 genes
plotPercentBars(vp[1:20,]) +
  scale_fill_jco()
```

```{r fig.width=5, fig.height=4}
# violin plot of contribution of each variable to total variance
plotVarPart(vp) +
  publ_theme +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))

ggsave2(
  filename = here::here("output", DOCNAME, "varPartATAC.covariate_contribution.pdf"),
  width = 5, height = 4
)
```

## Session info
