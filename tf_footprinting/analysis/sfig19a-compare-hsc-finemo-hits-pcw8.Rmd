---
title: "Compare HSC PCW8 Motif Hits over Development"
author: "Mervin M Fansler"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document: 
    code_folding: show
    df_print: paged
    theme: cosmo
    toc: true
    toc_float: true
---

# Purpose

Here we compare FiNeMo hits called in different PCWs, with motifs called in PCW8.

We are interested to know if some motifs are dynamic across developmental time.

# Initialization

## Libraries
```{r libs, message=FALSE, warning=FALSE}
library(magrittr)
library(tidyverse)
library(scales)
library(BiocParallel)
```

## Parameters
```{r set_params}
set.seed(20250709)
BiocParallel::register(MulticoreParam(8L))

MOTIF_SET="HSC_PCW8"

PDF_TOTAL_HITS="/work/aaa/projects/chrombpnet-devmult/figures/suppl-fig-18g-finemo-hits-hscs-pcw8.pdf"

CSV_PATTERN_ANNOTS=sprintf("/work/aaa/projects/chrombpnet-devmult/pipeline/results/chrombpnet_nobias/hsc_unified/%s/mean/modisco/counts_scores/df_motifs.csv.gz", MOTIF_SET)

TSV_STATS=str_c("/work/aaa/projects/chrombpnet-devmult/pipeline/results/chrombpnet_nobias/hsc_unified/HSC_PCW",
                seq(5,18),
                "/mean/finemo_cross_check/counts_scores/", MOTIF_SET, "/seqlet_report.tsv")

COLS_PCW=c(
  "HSC_PCW5"="#FFBF00",
  "HSC_PCW6"="#ff986d",
  "HSC_PCW7"="#ff8782",
  "HSC_PCW8"="#ff7b9b",
  "HSC_PCW9"="#f176b4",
  "HSC_PCW10"="#d97fce",
  "HSC_PCW11"="#b989e2",
  "HSC_PCW12"="#9094ed",
  "HSC_PCW13"="#60a4f2",
  "HSC_PCW14"="#32b1eb",
  "HSC_PCW15"="#29badb",
  "HSC_PCW16"="#4bc0c8",
  "HSC_PCW17"="#8dd7db",
  "HSC_PCW18"="#c0dedf")

theme_set(theme_bw())
```

## Functions

```{r methods}
get_order_by <- function (df, value="seqlet_recall", col="sample_id", row="pattern_lbl") {
  df %>%
    pivot_wider(id_cols=row, names_from=col, values_from=value) %>%
    column_to_rownames(row) %>%
    dist() %>%
    hclust() %>%
    {.$labels[.$order]}
}

get_order_by_weight <- function (df, value="seqlet_recall", col="sample_id", row="pattern_lbl") {
  df %>%
    pivot_wider(id_cols=row, names_from=col, values_from=value) %>%
    column_to_rownames(row) %>%
    { rownames(.)[order(as.matrix(.) %*% matrix(seq(14)-7, ncol=1), decreasing=TRUE)] }
}
```

# Data
## Loading
```{r load_data, message=FALSE}
df_motifs <- read_csv(CSV_PATTERN_ANNOTS)

pattern_lvls <- df_motifs$pattern

pat2lbl <- df_motifs %>%
  mutate(top_tf=str_match(match0, "^(.+)\\.H13CORE.*")[,2],
         pattern_type=str_extract(pattern, "^(pos|neg)"),
         pattern_num=str_extract(pattern, "\\d+$")) %>%
  mutate(pattern_lbl=str_c(MOTIF_SET, ".", pattern_type, "_", pattern_num, ".", top_tf)) %>%
  dplyr::select(pattern, pattern_lbl) %>%
  deframe()

df_hits <- tibble(file=TSV_STATS) %>%
  # extract sample id
  mutate(sample_id=str_match(file, "hsc_unified/(HSC_PCW[^/]+)")[,2]) %>%
  mutate(sample_id=fct(sample_id, names(COLS_PCW))) %>%
  # load all samples
  mutate(df_sample=map(file, read_tsv)) %>%
  unnest(df_sample) %>%
  # transfer pattern labels
  mutate(pattern_lbl=pat2lbl[motif_name]) %>%
  mutate(pattern_lbl_fct=fct(pattern_lbl, pat2lbl)) %>%
  # compute scaled values within patterns
  group_by(pattern_lbl) %>%
  mutate(across(starts_with("num_"), ~ as.numeric(scale(.x)), .names = "z_{.col}")) %>%
  mutate(across(starts_with("z_num_"), ~ ifelse(is.nan(.x), 0, .x))) %>%
  ungroup()
```

## Preprocessing
```{r prepare_data}

```

## Seqlets
```{r heat_seqlet_rates, fig.height=10, fig.width=5}
df_hits %>%
  ggplot(aes(x=sample_id, y=fct_rev(pattern_lbl_fct), fill=seqlet_recall)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_viridis_c() +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Seqlet\nRecall")

df_hits %>%
  ggplot(aes(x=sample_id, y=fct(pattern_lbl, get_order_by(df_hits, "seqlet_recall")), 
             fill=seqlet_recall)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_viridis_c() +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Seqlet\nRecall")

df_hits %>%
  ggplot(aes(x=sample_id, y=fct(pattern_lbl, get_order_by_weight(df_hits, "seqlet_recall")), 
             fill=seqlet_recall)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_viridis_c() +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Seqlet\nRecall")
```

## Seqlet-Hit Correlations
```{r heat_cwm_corr, fig.height=10, fig.width=5}
df_hits %>%
  ggplot(aes(x=sample_id, y=fct_rev(pattern_lbl_fct), fill=cwm_correlation)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_viridis_c() +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="CWM\nCorrelation")

df_hits %>%
  ggplot(aes(x=sample_id, y=fct(pattern_lbl, get_order_by(df_hits, "cwm_correlation")), 
             fill=cwm_correlation)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_viridis_c() +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="CWM\nCorrelation")

df_hits %>%
  ggplot(aes(x=sample_id, y=fct(pattern_lbl, get_order_by_weight(df_hits, "cwm_correlation")), 
             fill=cwm_correlation)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_viridis_c() +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="CWM\nCorrelation")
```

## Z-Scaled Total Hits
```{r heat_z_total_hits, fig.height=10, fig.width=5}
df_hits %>%
  ggplot(aes(x=sample_id, y=fct_rev(pattern_lbl_fct), fill=z_num_hits_total)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_gradient2(low=muted("blue"), high=muted("red")) +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Z-Score\nTotal\nHits")

df_hits %>%
  ggplot(aes(x=sample_id, y=fct(pattern_lbl, get_order_by(df_hits, "z_num_hits_total")),
             fill=z_num_hits_total)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_gradient2(low=muted("blue"), high=muted("red")) +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Z-Score\nTotal\nHits")

df_hits %>%
  ggplot(aes(x=sample_id, y=fct(pattern_lbl, get_order_by_weight(df_hits, "z_num_hits_total")),
             fill=z_num_hits_total)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_gradient2(low=muted("blue"), high=muted("red")) +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Z-Score\nTotal\nHits")
```

## Z-Scaled Restricted Hits
```{r heat_z_restricted_hits, fig.height=10, fig.width=5}
df_hits %>%
  ggplot(aes(x=sample_id, y=fct_rev(pattern_lbl_fct), fill=z_num_hits_restricted)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_gradient2(low=muted("blue"), high=muted("red")) +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Z-Score\nRestricted\nHits")

df_hits %>%
  ggplot(aes(x=sample_id, y=fct(pattern_lbl, get_order_by(df_hits, "z_num_hits_restricted")),
             fill=z_num_hits_restricted)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_gradient2(low=muted("blue"), high=muted("red")) +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Z-Score\nRestricted\nHits")

df_hits %>%
  ggplot(aes(x=sample_id, y=fct(pattern_lbl, get_order_by_weight(df_hits, "z_num_hits_restricted")),
             fill=z_num_hits_restricted)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_gradient2(low=muted("blue"), high=muted("red")) +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Z-Score\nRestricted\nHits")
```

## Z-Scaled Seqlets Missed by FiNeMo
```{r heat_z_num_seqlets_only, fig.height=10, fig.width=5}
df_hits %>%
  ggplot(aes(x=sample_id, y=fct_rev(pattern_lbl_fct), fill=z_num_seqlets_only)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_gradient2(low=muted("blue"), high=muted("red")) +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Z-Score\nSeqlets\nMissed")

df_hits %>%
  ggplot(aes(x=sample_id, y=fct(pattern_lbl, get_order_by(df_hits, "z_num_seqlets_only")),
             fill=z_num_seqlets_only)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_gradient2(low=muted("blue"), high=muted("red")) +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Z-Score\nSeqlets\nMissed")

df_hits %>%
  ggplot(aes(x=sample_id, y=fct(pattern_lbl, get_order_by_weight(df_hits, "z_num_seqlets_only")),
             fill=z_num_seqlets_only)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_gradient2(low=muted("blue"), high=muted("red")) +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Z-Score\nSeqlets\nMissed")
```

## Z-Scaled Seqlets Found by FiNeMo
```{r heat_z_num_overlaps, fig.height=10, fig.width=5}
df_hits %>%
  ggplot(aes(x=sample_id, y=fct_rev(pattern_lbl_fct), fill=z_num_overlaps)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_gradient2(low=muted("blue"), high=muted("red")) +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Z-Score\nSeqlets\nFound")

df_hits %>%
  ggplot(aes(x=sample_id, y=fct(pattern_lbl, get_order_by(df_hits, "z_num_overlaps")),
             fill=z_num_overlaps)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_gradient2(low=muted("blue"), high=muted("red")) +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Z-Score\nSeqlets\nFound")

df_hits %>%
  ggplot(aes(x=sample_id, y=fct(pattern_lbl, get_order_by_weight(df_hits, "z_num_overlaps")),
             fill=z_num_overlaps)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_gradient2(low=muted("blue"), high=muted("red")) +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Z-Score\nSeqlets\nFound")
```

## Z-Scaled Non-Seqlet Hits Found by FiNeMo
```{r heat_z_num_hits_restricted_only, fig.height=10, fig.width=5}
df_hits %>%
  ggplot(aes(x=sample_id, y=fct_rev(pattern_lbl_fct), fill=z_num_hits_restricted_only)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_gradient2(low=muted("blue"), high=muted("red")) +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Z-Score\nNon-Seqlet\nHits")

df_hits %>%
  ggplot(aes(x=sample_id, y=fct(pattern_lbl, get_order_by(df_hits, "z_num_hits_restricted_only")),
             fill=z_num_hits_restricted_only)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_gradient2(low=muted("blue"), high=muted("red")) +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Z-Score\nNon-Seqlet\nHits")

df_hits %>%
  ggplot(aes(x=sample_id, y=fct(pattern_lbl, get_order_by_weight(df_hits, "z_num_hits_restricted_only")),
             fill=z_num_hits_restricted_only)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_gradient2(low=muted("blue"), high=muted("red")) +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Z-Score\nNon-Seqlet\nHits")
```

## NFKB1
```{r plt_nfkb1, fig.width=4, fig.height=3}
TF_NAME="NFKB1"
TF_REGEX="NFKB1$"

df_hits %>%
  filter(str_detect(pattern_lbl, TF_REGEX)) %>%
  ggplot(aes(x=sample_id, y=num_overlaps, fill=sample_id)) +
  geom_bar(stat="identity", color='black', linewidth=0.2) +
  scale_fill_manual(values=COLS_PCW, guide="none") +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  scale_y_continuous(expand=c(0,0,0.1,0)) +
  labs(x=NULL, y="Seqlets detected by FiNeMo", title=TF_NAME)

df_hits %>%
  filter(str_detect(pattern_lbl, TF_REGEX)) %>%
  ggplot(aes(x=sample_id, y=num_seqlets_only, fill=sample_id)) +
  geom_bar(stat="identity", color='black', linewidth=0.2) +
  scale_fill_manual(values=COLS_PCW, guide="none") +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  scale_y_continuous(expand=c(0,0,0.1,0)) +
  labs(x=NULL, y="Seqlets missed by FiNeMo", title=TF_NAME)

df_hits %>%
  filter(str_detect(pattern_lbl, TF_REGEX)) %>%
  ggplot(aes(x=sample_id, y=seqlet_recall, fill=sample_id)) +
  geom_bar(stat="identity", color='black', linewidth=0.2) +
  scale_fill_manual(values=COLS_PCW, guide="none") +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  scale_y_continuous(expand=c(0,0,0.05,0), limits=c(0,1)) +
  labs(x=NULL, y="Seqlet recall rate", title=TF_NAME)

df_hits %>%
  filter(str_detect(pattern_lbl, TF_REGEX)) %>%
  ggplot(aes(x=sample_id, y=num_hits_total, fill=sample_id)) +
  geom_bar(stat="identity", color='black', linewidth=0.2) +
  scale_fill_manual(values=COLS_PCW, guide="none") +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  scale_y_continuous(expand=c(0,0,0.1,0)) +
  labs(x=NULL, y="Hits detected by FiNeMo", title=TF_NAME)
```


# Exports

```{r exports, fig.width=3, fig.height=11}
df_hits %>%
  mutate(pattern_lbl_short=str_replace(pattern_lbl, "^HSC_[^.]+\\.(neg|pos)(_[0-9]+)\\.(.*)$", "\\3\\2")) %>%
  ggplot(aes(x=sample_id, y=fct(pattern_lbl_short, get_order_by_weight(., "z_num_hits_total", row="pattern_lbl_short")),
             fill=z_num_hits_total)) +
  geom_tile(linewidth=0.1, color="black") +
  scale_fill_gradient2(low=muted("blue"), high=muted("red")) +
  scale_x_discrete(guide=guide_axis(angle=90)) +
  labs(x=NULL, y=NULL, fill="Z-Score\nTotal Hits") +
  theme(legend.position="bottom")

ggsave(PDF_TOTAL_HITS)
```

# Conclusions





---

# Runtime Details
## Session Info
<details>
```{r sesh_info, echo=FALSE}
sessionInfo()
```
</details>

## Conda Environment
<details>
```{bash conda_info, comment="", echo=FALSE}
if ! command -v conda &> /dev/null
then
  echo "Conda not detected."
elif [ -z "${CONDA_PREFIX}" ]
then
  echo "No active Conda environment."
else
  echo "## Conda Environment YAML"
  PREFIX=$(dirname $(dirname $(which R)))
  conda env export -p $PREFIX
fi
```
</details>
