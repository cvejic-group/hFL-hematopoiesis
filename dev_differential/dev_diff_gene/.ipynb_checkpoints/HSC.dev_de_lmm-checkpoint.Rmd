---
title: "HSC.dev_de_lmm"
---

- Run `HSC.dev_de_lmm.R` first

```{r knitr, include = FALSE}
DOCNAME <- "HSC.dev_de_lmm"
dir.create(here::here("output", DOCNAME), showWarnings = FALSE)

NOW <- Sys.time()
# Time chunks during knitting
knitr::knit_hooks$set(timeit = function(before) {
  if (before) {
    print(paste("Start:", Sys.time()))
    NOW <<- Sys.time()
  } else {
    print(paste("Stop:", Sys.time()))
    print(Sys.time() - NOW)
  }
})

knitr::opts_chunk$set(
  autodep        = TRUE,
  cache          = FALSE,
  cache.lazy     = FALSE,
  cache.comments = FALSE,
  echo           = TRUE,
  error          = FALSE,
  fig.align      = "center",
  fig.width      = 10,
  fig.height     = 8,
  message        = FALSE,
  warning        = FALSE,
  timeit         = TRUE
)
```

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(data.table)

# plot
library(ggsci)
library(RColorBrewer)
library(scales)
library(ComplexHeatmap)
library(pheatmap)
library(scattermore)
library(ggrastr)
library(ggrepel)
library(ggpubr)
library(patchwork)
library(cowplot)
mytheme <- theme_cowplot(
  font_size = 10,
  rel_small = 8 / 10,
  rel_tiny = 8 / 10,
  rel_large = 10 / 10
)

# specific
library(Seurat)

# ORA
library(clusterProfiler)
library(org.Hs.eg.db)
#library(msigdbr)
library(enrichR)

# misc
library(GenomicDistributions)
library(UpSetR)
library(ggvenn)

# set random seed for reproducibility
set.seed(12345)
```

```{r source, cache = FALSE}
#source(here::here("utils/preprocess.R"))
source(here::here("utils/markers.R"))
source(here::here("utils/plot.R"))
theme_set(publ_theme)
source("/work/DevM_analysis/utils/colors.R")
```

## Load data

Load

```{r}
mdata <- readRDS(here::here("output", DOCNAME, "mdata.rds"))
srat <- readRDS("/work/DevM_analysis/02.abundance/Milo_FL_HSC_PCW250401/data/FL_rna_clustered.rds")
table(srat$PCW, useNA = "ifany")
```

LMM

```{r}
df_de <- readRDS(here::here("output", DOCNAME, "HSC_lmm_de_time_df.rds"))
df_de_sig <- df_de[df_de$ltsr > 0.9,]
table(ifelse(df_de_sig$beta > 0, "up", "dn"))
```

## Beta vs. mean expr.

get mean rna of each gene

```{r eval=FALSE}
Y_lognorm <- qs::qread(here::here("output", "HSC.metacell", "gm_lognorm.qs"))
flag <- qs::qread(here::here("output", "HSC.metacell", "hsc_gene.flag_1_1.qs"))
Y_lognorm = Y_lognorm[flag, ]
df_mean_exp <- data.frame(gene = rownames(Y_lognorm), mean_exp = rowMeans(Y_lognorm))

saveRDS(df_mean_exp, file = here::here("output", DOCNAME, "df_mean_exp.rds"))
```

```{r fig.width=6, fig.height=5}
df_mean_exp <- readRDS(here::here("output", DOCNAME, "df_mean_exp.rds"))

df_de |> 
  mutate(sig = case_when(
    ltsr > 0.9 & beta > 0 ~ "up",
    ltsr > 0.9 & beta < 0 ~ "dn",
    TRUE ~ "ns"
  )) |> 
  left_join(df_mean_exp, by = "gene") |> 
  ggplot(aes(x = beta, y = mean_exp, color = sig)) +
  geom_point_rast() +
  stat_cor() +
  scale_color_manual(values = c("#0073C2FF", "gray", "#CD534CFF")) +
  labs(x = "LMM beta", y = "Mean log-normalized RNA count",
       title = glue::glue("All genes tested (n = {nrow(df_de)})"))
```

## DE

LTSR > 0.9

```{r}
DT::datatable(df_de_sig)
```

Check some top genes

```{r fig.width=12, fig.height=8}
VlnPlot(srat, features = c("NKAIN2", "MSI2", "CASC15", "CD74"), group.by = "PCW", ncol = 2, pt.size = 0.001)
VlnPlot(srat, features = c("HSPA1B", "DNAJB1", "TIMP3", "BAG3"), group.by = "PCW", ncol = 2, pt.size = 0.001)
```

```{r fig.width=8, fig.height=4}
DotPlot(srat, features = c("NKAIN2", "MSI2", "CASC15", "CD74",
                           "HSPH1", "DNAJB1", "TIMP3", "BAG3"),
        group.by = "PCW") +
  coord_flip()
```

HLA genes

```{r fig.width=12, fig.height=8}
VlnPlot(srat, features = c("HLA-B", "HLA-E", "HLA-C", "HLA-A"), group.by = "PCW", ncol = 2, pt.size = 0.001)
VlnPlot(srat, features = c("HLA-DRA", "HLA-DRB1", "HLA-DPB1", "HLA-DPA1"), group.by = "PCW", ncol = 2, pt.size = 0.001)
```

```{r fig.width=8, fig.height=6}
DotPlot(srat, features = c("HLA-B", "HLA-E", "HLA-C", "HLA-A",
                           "HLA-DRA", "HLA-DRB1", "HLA-DPB1", "HLA-DPA1"),
        group.by = "PCW") +
  coord_flip()
```

### Heatmap {.tabset}

#### HSC genes and HLA

Plot heatmap, marker HSC genes and HLA

```{r fig.width=1.5, fig.height=6}
# beta
mat <- as.matrix(df_de_sig[,"beta"])
colnames(mat)[1] <- "beta"
rownames(mat) <- df_de_sig$gene

# color
range(mat[,1])
quantile(mat[,1], c(0.01, 0.05, 0.1, 0.5, 0.8, 0.9, 0.95, 0.99), na.rm=TRUE)
col_fun = circlize::colorRamp2(c(-0.4, 0, 0.4), c("blue", "white", "red"))

# label location
marker_2_lab <- intersect(rownames(mat), c(Hanna_HSC_signature, Hanna_HSC_TFs, grep("HLA", rownames(mat), value = T)))
marker_2_lab = sapply(marker_2_lab, function(x){which(rownames(mat) == x)}, simplify = T)
ha = rowAnnotation(foo = anno_mark(at = marker_2_lab,
                                   labels = names(marker_2_lab),
                                   labels_gp = gpar(fontsize = 6)))

ht = Heatmap(mat, name = "beta",
        col = col_fun,
        right_annotation = ha,
        cluster_columns = F,
        cluster_rows = F,
        show_row_names = FALSE,
        column_names_gp = gpar(fontsize = 6),
        #column_names_rot = 60,
        heatmap_legend_param = list(#direction = "horizontal",
                                    labels_gp = gpar(fontsize = 6),
                                    title_gp = gpar(fontsize = 6),
                                    #title_position = "leftcenter",
                                    grid_height = unit(2, "mm"),
                                    grid_width = unit(2, "mm"))
        )
#draw(ht, heatmap_legend_side = "bottom")
p.beta = plot_grid(grid.grabExpr(draw(ht, heatmap_legend_side = "right")))
p.beta
```

#### cell cycle

Plot heatmap, marker cell cycle genes

```{r fig.width=1.5, fig.height=6}
# label location
marker_2_lab <- intersect(rownames(mat), c(cc.genes.updated.2019$s.genes, cc.genes.updated.2019$g2m.genes))
marker_2_lab = sapply(marker_2_lab, function(x){which(rownames(mat) == x)}, simplify = T)
ha = rowAnnotation(foo = anno_mark(at = marker_2_lab,
                                   labels = names(marker_2_lab),
                                   labels_gp = gpar(fontsize = 6)))

ht = Heatmap(mat, name = "beta",
        col = col_fun,
        right_annotation = ha,
        cluster_columns = F,
        cluster_rows = F,
        show_row_names = FALSE,
        column_names_gp = gpar(fontsize = 6),
        #column_names_rot = 60,
        heatmap_legend_param = list(#direction = "horizontal",
                                    labels_gp = gpar(fontsize = 6),
                                    title_gp = gpar(fontsize = 6),
                                    #title_position = "leftcenter",
                                    grid_height = unit(2, "mm"),
                                    grid_width = unit(2, "mm"))
        )
p.beta = plot_grid(grid.grabExpr(draw(ht, heatmap_legend_side = "right")))
p.beta
```

#### Ribo

```{r fig.width=1.5, fig.height=6}
# label location
marker_2_lab <- intersect(rownames(mat), grep("^RPL|^RPS", df_de$gene, value = T))
marker_2_lab = sapply(marker_2_lab, function(x){which(rownames(mat) == x)}, simplify = T)
ha = rowAnnotation(foo = anno_mark(at = marker_2_lab,
                                   labels = names(marker_2_lab),
                                   labels_gp = gpar(fontsize = 6)))

ht = Heatmap(mat, name = "beta",
        col = col_fun,
        right_annotation = ha,
        cluster_columns = F,
        cluster_rows = F,
        show_row_names = FALSE,
        column_names_gp = gpar(fontsize = 6),
        #column_names_rot = 60,
        heatmap_legend_param = list(#direction = "horizontal",
                                    labels_gp = gpar(fontsize = 6),
                                    title_gp = gpar(fontsize = 6),
                                    #title_position = "leftcenter",
                                    grid_height = unit(2, "mm"),
                                    grid_width = unit(2, "mm"))
        )
#draw(ht, heatmap_legend_side = "bottom")
p.beta = plot_grid(grid.grabExpr(draw(ht, heatmap_legend_side = "right")))
p.beta
```

#### KEGG_APOPTOSIS

```{r fig.width=1.5, fig.height=6}
library(limma)

tab <- getGeneKEGGLinks(species="hsa")
tab$Symbol <- mapIds(org.Hs.eg.db, tab$GeneID,
                       column="SYMBOL", keytype="ENTREZID")
APOPTOSIS = tab %>% filter(PathwayID == "hsa04210") %>% pull(Symbol)

# label location
marker_2_lab <- intersect(rownames(mat), APOPTOSIS)
marker_2_lab = sapply(marker_2_lab, function(x){which(rownames(mat) == x)}, simplify = T)
ha = rowAnnotation(foo = anno_mark(at = marker_2_lab,
                                   labels = names(marker_2_lab),
                                   labels_gp = gpar(fontsize = 6)))

ht = Heatmap(mat, name = "beta",
        col = col_fun,
        right_annotation = ha,
        cluster_columns = F,
        cluster_rows = F,
        show_row_names = FALSE,
        column_names_gp = gpar(fontsize = 6),
        #column_names_rot = 60,
        heatmap_legend_param = list(#direction = "horizontal",
                                    labels_gp = gpar(fontsize = 6),
                                    title_gp = gpar(fontsize = 6),
                                    #title_position = "leftcenter",
                                    grid_height = unit(2, "mm"),
                                    grid_width = unit(2, "mm"))
        )
p.beta = plot_grid(grid.grabExpr(draw(ht, heatmap_legend_side = "right")))
p.beta
```

### GSEA {.tabset}

```{r eval=FALSE}
tmp_df <- bitr(df_de$gene, fromType="SYMBOL", toType=c("ENTREZID"), OrgDb="org.Hs.eg.db")
tmp_df2 <- bitr(UpdateSymbolList(setdiff(df_de$gene, tmp_df$SYMBOL), verbose = FALSE),
                fromType="SYMBOL", toType=c("ENTREZID"), OrgDb="org.Hs.eg.db")
tmp_df <- rbind(tmp_df, tmp_df2)

# TEC/HBD has two entries
tmp_df <- tmp_df |> 
  distinct() |> 
  filter(!(ENTREZID %in% c("100124696", "100187828"))) |> 
  dplyr::rename(gene = SYMBOL)

df_de <- df_de |> 
  left_join(tmp_df, by = "gene") |> 
  filter(!is.na(ENTREZID))
# 12362 left

# save
geneList <- setNames(df_de$beta, df_de$ENTREZID)
saveRDS(geneList, file = here::here("output", DOCNAME, "HSC_lmm_de_time.geneList_4_ora.rds"))

# gse
gse_kg <- gseKEGG(geneList     = geneList,
               organism     = 'hsa',
               minGSSize    = 10,
               pvalueCutoff = 0.05,
               eps = 0,
               verbose      = FALSE)
gse_kg <- setReadable(gse_kg, 'org.Hs.eg.db', keyType = "ENTREZID")
saveRDS(gse_kg, file = here::here("output", DOCNAME, "HSC_lmm_de_time.GSEA_KEGG.rds"))
as.data.frame(gse_kg) |> 
  write_tsv(here::here("output", DOCNAME, "HSC_lmm_de_time.GSEA_KEGG.tsv"))

# gse, hallmark
h_t2g = read.gmt('~/RefData/MSigDB/h.all.v2024.1.Hs.entrez.gmt')
em2 <- GSEA(geneList, TERM2GENE = h_t2g, eps = 0)
em2 <- setReadable(em2, 'org.Hs.eg.db', keyType = "ENTREZID")
saveRDS(em2, file = here::here("output", DOCNAME, "HSC_lmm_de_time.GSEA_Hallmark.rds"))
as.data.frame(em2) |> 
  write_tsv(here::here("output", DOCNAME, "HSC_lmm_de_time.GSEA_Hallmark.tsv"))
```

#### Hallmark

```{r}
em2 <- readRDS(here::here("output", DOCNAME, "HSC_lmm_de_time.GSEA_Hallmark.rds"))

as.data.frame(em2) |> 
  filter(qvalue < 0.05) |> 
  dplyr::select(ID, setSize, NES, qvalue) |> 
  arrange(-NES) |> 
  DT::datatable()
```

```{r fig.width=6, fig.height=4}
gseaplot(em2, geneSetID = "HALLMARK_INTERFERON_GAMMA_RESPONSE", by = "runningScore", title = "HALLMARK_INTERFERON_GAMMA_RESPONSE")
```

```{r fig.width=6, fig.height=4}
gseaplot(em2, geneSetID = "HALLMARK_INFLAMMATORY_RESPONSE", by = "runningScore", title = "HALLMARK_INFLAMMATORY_RESPONSE	")
```

```{r fig.width=6, fig.height=4}
gseaplot(em2, geneSetID = "HALLMARK_OXIDATIVE_PHOSPHORYLATION", by = "runningScore", title = "HALLMARK_OXIDATIVE_PHOSPHORYLATION")
```

```{r fig.width=6, fig.height=4}
gseaplot(em2, geneSetID = "HALLMARK_GLYCOLYSIS", by = "runningScore", title = "HALLMARK_GLYCOLYSIS")
```

```{r fig.width=6, fig.height=4}
gseaplot(em2, geneSetID = "HALLMARK_MTORC1_SIGNALING", by = "runningScore", title = "HALLMARK_MTORC1_SIGNALING")
```

#### KEGG

```{r}
gse_kg <- readRDS(here::here("output", DOCNAME, "HSC_lmm_de_time.GSEA_KEGG.rds"))

as.data.frame(gse_kg) |> 
  filter(qvalue < 0.01) |> 
  dplyr::select(ID, Description, setSize, enrichmentScore, NES, qvalue) |> 
  arrange(-NES) |> 
  DT::datatable()
```

```{r fig.width=6, fig.height=4}
gseaplot(gse_kg, geneSetID = "hsa04514", by = "runningScore", title = "Cell adhesion molecules")
```

### ORA {.tabset}

```{r eval=FALSE}
compareList <- list(
  # 10.93% of input gene IDs are fail to map
  up = df_de_sig |> filter(beta > 0) |> pull(gene) |> UpdateSymbolList(verbose = FALSE) |> 
    bitr(fromType="SYMBOL", toType=c("ENTREZID"), OrgDb="org.Hs.eg.db") |> 
    pull(ENTREZID),
  # 1.06% of input gene IDs are fail to map
  dn = df_de_sig |> filter(beta < 0) |> pull(gene) |> UpdateSymbolList(verbose = FALSE) |> 
    bitr(fromType="SYMBOL", toType=c("ENTREZID"), OrgDb="org.Hs.eg.db") |> 
    pull(ENTREZID)
)
saveRDS(compareList, file = here::here("output", DOCNAME, "HSC_lmm_de_time.compareList_4_ora.rds"))

# ORA, KEGG
ck = compareCluster(compareList, fun = "enrichKEGG", organism = "hsa", pvalueCutoff = 0.05)
ck <- setReadable(ck, 'org.Hs.eg.db', keyType = "ENTREZID")
saveRDS(ck, file = here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_KEGG.rds"))
as.data.frame(ck) |> 
  write_tsv(here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_KEGG.tsv"))

# ORA, KEGG Module
ckm <- compareCluster(compareList, fun = "enrichMKEGG", organism = "hsa", pvalueCutoff = 1, qvalueCutoff = 1)
ckm <- setReadable(ckm, 'org.Hs.eg.db', keyType = "ENTREZID")
saveRDS(ckm, file = here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_KEGG_Module.rds"))
as.data.frame(ckm) |> 
  write_tsv(here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_KEGG_Module.tsv"))

# ORA, GO-BP
cg.BP = compareCluster(compareList, fun = "enrichGO", OrgDb = org.Hs.eg.db, ont = "BP",
                       pAdjustMethod = "BH", pvalueCutoff = 0.01, qvalueCutoff = 0.05, readable = T)
saveRDS(cg.BP, file = here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_GOBP.rds"))
as.data.frame(cg.BP) |> 
  write_tsv(here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_GOBP.tsv"))

# ORA, GO-MF
cg.MF = compareCluster(compareList, fun = "enrichGO", OrgDb = org.Hs.eg.db, ont = "MF",
                       pAdjustMethod = "BH", pvalueCutoff = 0.01, qvalueCutoff = 0.05, readable = T)
saveRDS(cg.MF, file = here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_GOMF.rds"))
as.data.frame(cg.MF) |> 
  write_tsv(here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_GOMF.tsv"))

# ORA, GO-CC
cg.CC = compareCluster(compareList, fun = "enrichGO", OrgDb = org.Hs.eg.db, ont = "CC",
                       pAdjustMethod = "BH", pvalueCutoff = 0.01, qvalueCutoff = 0.05, readable = T)
saveRDS(cg.CC, file = here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_GOCC.rds"))
as.data.frame(cg.CC) |> 
  write_tsv(here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_GOCC.tsv"))

# ORA, hallmark
h_t2g = read.gmt('~/RefData/MSigDB/h.all.v2024.1.Hs.entrez.gmt')
ce.H = compareCluster(compareList, fun = "enricher", TERM2GENE = h_t2g)
ce.H <- setReadable(ce.H, 'org.Hs.eg.db', keyType = "ENTREZID")
saveRDS(ce.H, file = here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_Hallmark.rds"))
as.data.frame(ce.H) |> 
  write_tsv(here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_Hallmark.tsv"))
```

#### Hallmark

```{r , fig.width=8, fig.height=5}
ce.H <- readRDS(here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_Hallmark.rds"))
dotplot(ce.H, showCategory = 10) + 
  scale_y_discrete(labels = function(x) str_wrap(x, width = 50))
```

```{r fig.width=10, fig.height=8, eval=FALSE}
# not run due to
# https://github.com/YuLab-SMU/enrichplot/issues/315
cnetplot(ce.H, node_label = 'all')
```

#### KEGG

```{r , fig.width=8, fig.height=8}
ck <- readRDS(here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_KEGG.rds"))
dotplot(ck, showCategory = 10) + 
  scale_y_discrete(labels = function(x) str_wrap(x, width = 50))
```

#### KEGG module

```{r , fig.width=8, fig.height=8}
ckm <- readRDS(here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_KEGG_Module.rds"))
dotplot(ckm, showCategory = 10) + 
  scale_y_discrete(labels = function(x) str_wrap(x, width = 50))
```

```{r fig.width=10, fig.height=8, eval=FALSE}
cnetplot(ckm, node_label = 'all')
```

#### GO-BP

```{r , fig.width=7, fig.height=8}
cg.BP <- readRDS(here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_GOBP.rds"))
dotplot(cg.BP, showCategory = 10) + 
  scale_y_discrete(labels = function(x) str_wrap(x, width = 50))
```

simplify

```{r , fig.width=7, fig.height=8}
p <- dotplot(simplify(cg.BP, cutoff = 0.5), showCategory = 10) + 
  scale_y_discrete(labels = function(x) str_wrap(x, width = 50))
p
```

#### GO-MF

```{r , fig.width=7, fig.height=8}
cg.MF <- readRDS(here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_GOMF.rds"))
dotplot(cg.MF, showCategory = 10) + 
  scale_y_discrete(labels = function(x) str_wrap(x, width = 50))
```

simplify

```{r , fig.width=7, fig.height=8}
p <- dotplot(simplify(cg.MF, cutoff = 0.5), showCategory = 10) + 
  scale_y_discrete(labels = function(x) str_wrap(x, width = 50))
p
```

#### GO-CC

```{r , fig.width=7, fig.height=8}
cg.CC <- readRDS(here::here("output", DOCNAME, "HSC_lmm_de_time.ORA_GOCC.rds"))
dotplot(cg.CC, showCategory = 10) + 
  scale_y_discrete(labels = function(x) str_wrap(x, width = 50))
```

simplify

```{r , fig.width=7, fig.height=8}
p <- dotplot(simplify(cg.CC, cutoff = 0.5), showCategory = 10) + 
  scale_y_discrete(labels = function(x) str_wrap(x, width = 50))
p
```

## Session info

